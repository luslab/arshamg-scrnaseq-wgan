// Crick specific computing max resource levels
params {
  max_memory = 224.GB
  max_cpus = 32
  max_gpus = 4
  max_time = 72.h
}

singularity {
  enabled = true
  autoMounts = true
}

// Load some standard modules before running script
process {
  executor = 'slurm'

  withName: runGann {
    // Cluster options
    cpus = { check_max( 8, 'cpus' ) }
    memory = { check_max( 16.GB * task.attempt, 'memory' ) }

    // Check if GPU enabled
    if(!params.numGPUs) {
      queue = 'cpu'
    }
    else if(params.numGPUs == "0") {
      queue = 'cpu'
    }
    else {
      queue = 'gpu'
      clusterOptions = "--gres=gpu:" + { check_max( params.numGPUs, 'gpu' ) }
    }

    // Container options for GPU enabled instances
    container = 'luslab/tensorflow-gpu:latest'
    docker.runOptions = '--gpus all -u \$(id -u):\$(id -g)'
    singularity.runOptions = '--nv'
  }
}